<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4024.13">
  <POU Name="Mixing" Id="{c7d77201-326e-43f5-84be-5e5d3f37b70d}" SpecialFunc="None">
    <Declaration><![CDATA[FUNCTION_BLOCK Mixing
VAR_INPUT
	diEnabled : BOOL;
	iSecImp : BOOL;
END_VAR
VAR_OUTPUT
	doEnabled : BOOL;
END_VAR
VAR_IN_OUT
	MixingPhase : TPhaseMixing;
	MixerEng : TEngine;
END_VAR
VAR
ElapsedTime : INT;
iR_TRIG : R_TRIG;
END_VAR
]]></Declaration>
    <Implementation>
      <ST><![CDATA[

{region "Aut/Man"}
// Přepínání mezi automatickým a manuálním režimem
IF MixingPhase.Cmd.AutCtrl THEN
    MixingPhase.State.AutCtrl := TRUE;
    MixingPhase.State.ManCtrl := FALSE;
    MixerEng.Cmd.AutCtrl := TRUE;
END_IF;

IF MixingPhase.Cmd.ManCtrl THEN
    MixingPhase.State.ManCtrl := TRUE;
    MixingPhase.State.AutCtrl := FALSE;
    MixerEng.Cmd.ManCtrl := TRUE;
END_IF;

IF NOT MixingPhase.State.AutCtrl AND NOT MixingPhase.State.ManCtrl THEN
    MixingPhase.State.ManCtrl := TRUE;
END_IF;
{endregion}

{region "ManCtrl"}
// Manuální režim
IF MixingPhase.State.ManCtrl THEN
    IF MixingPhase.Cmd.StartMan AND MixingPhase.State.Idle THEN
        MixingPhase.State.Running := TRUE;
        MixingPhase.State.Idle := FALSE;
        MixingPhase.State.Paused := FALSE;
        MixingPhase.State.Done := FALSE;
        MixerEng.Cmd.TurnOnMan := TRUE; // Spuštění motoru v manuálním režimu
    END_IF;

    IF MixingPhase.Cmd.PauseMan AND MixingPhase.State.Running THEN
        MixingPhase.State.Paused := TRUE;
        MixingPhase.State.Running := FALSE;
        MixerEng.Cmd.TurnOffMan := TRUE; // Zastavení motoru
    END_IF;

    IF MixingPhase.Cmd.ResumeMan AND MixingPhase.State.Paused THEN
        MixingPhase.State.Running := TRUE;
        MixingPhase.State.Paused := FALSE;
        MixerEng.Cmd.TurnOnMan := TRUE; // Znovu spuštění motoru
    END_IF;

    IF MixingPhase.Cmd.StopMan AND (MixingPhase.State.Running OR MixingPhase.State.Paused) THEN
        MixingPhase.State.Idle := TRUE;
        MixingPhase.State.Paused := FALSE;
        MixingPhase.State.Running := FALSE;
        MixingPhase.State.Done := FALSE;
        MixerEng.Cmd.TurnOffMan := TRUE; // Zastavení motoru
    END_IF;

    MixingPhase.Cmd.StartMan := FALSE;
    MixingPhase.Cmd.PauseMan := FALSE;
    MixingPhase.Cmd.ResumeMan := FALSE;
    MixingPhase.Cmd.StopMan := FALSE;
END_IF;
{endregion}

{region "AutCtrl"}
// Automatický režim
IF MixingPhase.State.AutCtrl THEN
    IF MixingPhase.Cmd.StartAut AND MixingPhase.State.Idle THEN
        MixingPhase.State.Running := TRUE;
        MixingPhase.State.Idle := FALSE;
        MixerEng.Cmd.Req2RunAutCtrl := TRUE; // Požadavek na automatické spuštění motoru
    END_IF;

    IF MixingPhase.Cmd.StopAut AND MixingPhase.State.Running THEN
        MixingPhase.State.Idle := TRUE;
        MixingPhase.State.Running := FALSE;
        MixerEng.Cmd.Req2RunAutCtrl := FALSE; // Požadavek na zastavení motoru
    END_IF;

    MixingPhase.Cmd.StartAut := FALSE;
    MixingPhase.Cmd.StopAut := FALSE;
END_IF;
{endregion}

{region "Done"}
// Podmínka dokončení fáze
iR_TRIG(CLK := iSecImp);

IF iR_TRIG.Q THEN
    IF MixingPhase.State.Idle THEN
        ElapsedTime := 0;
    ELSIF MixingPhase.State.Running THEN
        ElapsedTime := ElapsedTime + 1;
    END_IF;
END_IF;

IF ElapsedTime >= MixingPhase.ParamTimeSec THEN
    MixingPhase.State.Done := TRUE;
END_IF;

IF MixingPhase.Cmd.ResetDone THEN
    MixingPhase.State.Done := FALSE;
    MixingPhase.Cmd.ResetDone := FALSE;
END_IF;
{endregion}

{region "States"}
// Řízení motoru podle stavů
IF MixingPhase.State.Running THEN
    MixerEng.Cmd.Req2RunAutCtrl := TRUE;
END_IF;

IF MixingPhase.State.Idle OR MixingPhase.State.Paused THEN
    MixerEng.Cmd.Req2RunAutCtrl := FALSE;
END_IF;
{endregion}

// Výchozí stav fáze - Idle
IF NOT MixingPhase.State.Idle AND NOT MixingPhase.State.Paused AND NOT MixingPhase.State.Running THEN
    MixingPhase.State.Idle := TRUE;
END_IF;

// Vizualizace stavu fáze
IF MixingPhase.State.Idle THEN
    MixingPhase.State.StateInt := Global.PhIdle;
ELSIF MixingPhase.State.Running THEN
    MixingPhase.State.StateInt := Global.PhRunning;
ELSE
    MixingPhase.State.StateInt := Global.PhPause;
END_IF;

doEnabled := diEnabled;
]]></ST>
    </Implementation>
    <LineIds Name="Mixing">
      <LineId Id="566" Count="126" />
      <LineId Id="166" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>